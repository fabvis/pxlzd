import { getSession } from '@/lib/session'
import { getExternalPool } from '@/lib/db'
function dateYYMMDDInZurich(){ const fmt=new Intl.DateTimeFormat('fr-CH',{timeZone:'Europe/Zurich',year:'2-digit',month:'2-digit',day:'2-digit'}); const parts=fmt.formatToParts(new Date()); const dd=parts.find(p=>p.type==='day')?.value||'01'; const mm=parts.find(p=>p.type==='month')?.value||'01'; const yy=parts.find(p=>p.type==='year')?.value||'00'; return `${yy}${mm}${dd}` }
export default async function DashboardPage(){ const session=await getSession(); const username=session?.sub||'inconnu'; const yymmdd=dateYYMMDDInZurich(); const table=`cover${yymmdd}`; let count=0; let error:string|null=null; try{ const pool=getExternalPool(); const [rows]=await pool.query(`SELECT COUNT(*) AS c FROM \`${table}\``) as any; count=rows?.[0]?.c??0 }catch(e:any){ error=`Impossible de lire la table ${table}: ${e?.message||'erreur inconnue'}` }
  return(<div className='main-wrap'><div className='card callout success'><h1><i className='bi bi-person-check'></i> Connecté</h1><p>Bienvenue <b>{username}</b>. Tu es bien connecté.</p><p>Joueurs du jour (table <code>{table}</code>) : <b>{count}</b></p>{error && <p className='status err'>{error}</p>}<p><a className='link' href='/'>← Retour</a> • <a className='link' href='/api/session/me' target='_blank'>/api/session/me</a> • <form method='post' action='/api/logout' style={{display:'inline'}}><button className='button tiny' style={{marginLeft:8}}>Logout</button></form></p></div></div>) }
